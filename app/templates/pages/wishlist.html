{% extends "base.html" %} {% block title %}GiftMe - Wishlist{% endblock %} {%
block content %}

<div class="header">
  <div class="profile-section">
    <a href="/twa/" class="nav-button">‚Üê</a>
    <div class="profile-pic"></div>
    <div>{% if user %}{{ user.username }}{% else %}Guest{% endif %}</div>
  </div>
  <div>‚ãÆ</div>
</div>

<div class="p-4" role="main">
  <h1 class="text-2xl font-bold mb-4">Wishlist</h1>

  {% if selected_gift %}
  <div class="bg-teal-900 bg-opacity-20 rounded-xl p-4 backdrop-blur-sm mb-6">
    <h2 class="text-xl font-semibold mb-2">Selected Gift</h2>
    <div class="bg-teal-900 bg-opacity-10 rounded-xl p-4">
      <h3 class="text-lg font-bold">{{ selected_gift.name }}</h3>
      <p class="text-gray-300">{{ selected_gift.description }}</p>
      <p class="text-teal-300 mt-2">Price: ${{ selected_gift.price }}</p>
    </div>
  </div>
  {% endif %}

  <div class="mt-8">
    <h2 class="text-xl font-semibold mb-4">Gift Lists</h2>
    <div class="space-y-4">
      {% for list in gift_lists %}
      <div class="bg-teal-900 bg-opacity-10 rounded-xl p-4">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-bold">{{ list.name }}</h3>
          {% if selected_gift %}
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              class="form-checkbox h-5 w-5 text-teal-600"
              onchange="toggleGiftInList('{{ selected_gift.id }}', '{{ list.id }}', this.checked)"
              {%
              if
              list.id
              in
              selected_gift_lists
              %}checked{%
              endif
              %}
            />
            <span class="ml-2">Add here</span>
          </label>
          {% endif %}
        </div>
        {% if list.gifts %}
        <div class="mt-2 text-sm text-gray-400">
          Gifts: {{ list.gifts|length }}
        </div>
        {% endif %}
      </div>
      {% else %}
      <p class="text-center text-gray-400">You have no gift lists yet.</p>
      {% endfor %}
    </div>
  </div>
</div>

<nav class="bottom-nav">
  <button class="nav-button">‚â°</button>
  <button class="nav-button">üéß</button>
  <button class="nav-button">üîî</button>
  <button class="nav-button">üì§</button>
</nav>

{% endblock %} {% block extra_scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    window.toggleGiftInList = async function (giftId, listId, checked) {
      try {
        const response = await AuthManager.fetchWithAuth(
          "/twa/api/giftlist/toggle",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              gift_id: giftId,
              list_id: listId,
              action: checked ? "add" : "remove",
            }),
          }
        );

        if (response.ok) {
          if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.HapticFeedback.notificationOccurred(
              "success"
            );
            window.Telegram.WebApp.showPopup({
              message: checked
                ? "Gift added to list"
                : "Gift removed from list",
              buttons: [{ type: "ok" }],
            });
          }
        } else {
          const error = await response.json();
          if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.HapticFeedback.notificationOccurred("error");
            window.Telegram.WebApp.showPopup({
              message: error.detail || "Failed to update gift list",
              buttons: [{ type: "ok" }],
            });
          }
        }
      } catch (error) {
        console.error("Error:", error);
        if (window.Telegram?.WebApp) {
          window.Telegram.WebApp.HapticFeedback.notificationOccurred("error");
          window.Telegram.WebApp.showAlert(
            "Failed to update gift list. Please try again."
          );
        }
      }
    };
  });
</script>
{% endblock %}
