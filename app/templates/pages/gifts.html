{% extends "base.html" %} {% block title %}GiftMe - {{ page_title }}{% endblock
%} {% block content %}

<div class="header">
  <div class="profile-section">
    <a href="/twa/" class="nav-button">â†</a>
    <div class="profile-pic"></div>
    <div>{% if user %}{{ user.username }}{% else %}Guest{% endif %}</div>
  </div>
  <div>â‹®</div>
</div>

<div class="p-4" role="main">
  <h1 class="text-2xl font-bold mb-4">{{ page_title }}</h1>

  <div class="bg-teal-900 bg-opacity-20 rounded-xl p-4 backdrop-blur-sm">
    <h2 class="text-xl font-semibold mb-2">Create a New Gift</h2>
    <form id="giftForm" class="space-y-4">
      <div class="space-y-2">
        <label for="name" class="block">Gift Name</label>
        <input
          type="text"
          id="name"
          name="name"
          required
          class="w-full p-2 rounded bg-white bg-opacity-10 border border-teal-500 text-white"
        />
      </div>

      <div class="space-y-2">
        <label for="description" class="block">Description</label>
        <textarea
          id="description"
          name="description"
          required
          class="w-full p-2 rounded bg-white bg-opacity-10 border border-teal-500 text-white"
        ></textarea>
      </div>

      <div class="space-y-2">
        <label for="price" class="block">Price</label>
        <input
          type="number"
          id="price"
          name="price"
          step="0.01"
          required
          class="w-full p-2 rounded bg-white bg-opacity-10 border border-teal-500 text-white"
        />
      </div>

      <button
        type="submit"
        class="w-full py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 transition-colors"
      >
        Add Gift
      </button>
    </form>
  </div>

  <div class="mt-8">
    <h2 class="text-xl font-semibold mb-4">My Gifts</h2>
    <div class="space-y-4">
      {% for gift in gifts %}
      <div class="bg-teal-900 bg-opacity-10 rounded-xl p-4">
        <h3 class="text-lg font-bold">{{ gift.name }}</h3>
        <p class="text-gray-300">{{ gift.description }}</p>
        <p class="text-teal-300 mt-2">Price: ${{ gift.price }}</p>
        {% if gift.lists %}
        <p class="text-sm mt-2 text-gray-400">
          Part of giftlist(s): {{ gift.lists | join(", ") }}
        </p>
        {% endif %}
      </div>
      {% else %}
      <p class="text-center text-gray-400">You have no gifts yet.</p>
      {% endfor %}
    </div>
  </div>
</div>

<nav class="bottom-nav">
  <button class="nav-button">â‰¡</button>
  <button class="nav-button">ğŸ§</button>
  <button class="nav-button">ğŸ””</button>
  <button class="nav-button">ğŸ“¤</button>
</nav>

{% endblock %} {% block extra_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
      const currentUserId = {{ user.id }};
      console.log('currentUserId:', currentUserId);

      const form = document.getElementById('giftForm');
      form.addEventListener('submit', async (e) => {
          e.preventDefault();

          const formData = new FormData(form);
          const giftData = {
              name: formData.get('name'),
              description: formData.get('description'),
              price: parseFloat(formData.get('price')),
              owner_id: currentUserId
          };

          try {
              const response = await AuthManager.fetchWithAuth('/twa/api/gifts', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(giftData)
              });

              if (response.ok) {
                  const result = await response.json();
                  console.log('Gift created:', result);

                  // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ± ÑƒÑĞ¿ĞµÑ…Ğµ Ñ‡ĞµÑ€ĞµĞ· Telegram WebApp
                  if (window.Telegram?.WebApp) {
                      // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ haptic feedback Ğ´Ğ»Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ
                      window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');

                      // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ
                      // window.Telegram.WebApp.showAlert('Gift was successfully created!', () => {
                      //     // ĞŸĞ¾ÑĞ»Ğµ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ Ğ°Ğ»ĞµÑ€Ñ‚Ğ° Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ
                        window.location.href = AuthManager.addParamsToUrl(window.location.pathname);
                      // });
                  } else {
                      window.location.href = AuthManager.addParamsToUrl(window.location.pathname);
                  }
              } else {
                  const error = await response.json();
                  console.error('Error creating gift:', error);

                  // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ñ‡ĞµÑ€ĞµĞ· Telegram WebApp
                  if (window.Telegram?.WebApp) {
                      // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ haptic feedback Ğ´Ğ»Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸
                      window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
                      // window.Telegram.WebApp.showAlert(error.detail || 'Failed to create gift');
                  } else {
                      alert('Error creating gift: ' + error.detail);
                  }
              }
          } catch (error) {
              console.error('Error:', error);

              // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ñ‡ĞµÑ€ĞµĞ· Telegram WebApp
              if (window.Telegram?.WebApp) {
                  window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
                  window.Telegram.WebApp.showAlert('Failed to create gift. Please try again.');
              } else {
                  alert('Error creating gift');
              }
          }
      });

      // ĞœĞµĞ½ÑĞµĞ¼ Ñ†Ğ²ĞµÑ‚ Ñ‚ĞµĞ¼Ñ‹ Ğ² ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğ¸ Ñ Ñ‚ĞµĞ¼Ğ¾Ğ¹ Telegram
      if (window.Telegram?.WebApp) {
          const theme = window.Telegram.WebApp.themeParams;
          if (theme) {
              document.documentElement.style.setProperty('--tg-theme-bg-color', theme.bg_color);
              document.documentElement.style.setProperty('--tg-theme-text-color', theme.text_color);
              document.documentElement.style.setProperty('--tg-theme-button-color', theme.button_color);
              document.documentElement.style.setProperty('--tg-theme-button-text-color', theme.button_text_color);
          }
      }

      // ĞĞ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾: Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ² Ñ…ĞµĞ´ĞµÑ€ Telegram
      if (window.Telegram?.WebApp?.MainButton) {
          const mainButton = window.Telegram.WebApp.MainButton;
          mainButton.setText('Add New Gift');
          mainButton.onClick(() => {
              form.scrollIntoView({ behavior: 'smooth' });
          });
          mainButton.show();
      }
  });
</script>
{% endblock %}
